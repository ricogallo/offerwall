{"version":3,"sources":["script.js"],"names":["offersURL","offersListEl","document","querySelector","statusEl","loadFromStorage","store","JSON","parse","localStorage","getItem","saveIntoStorage","val","setItem","stringify","fetchOffers","Promise","resolve","reject","request","XMLHttpRequest","open","onload","this","status","offers","response","send","sendToTracker","data","createElement","opts","el","name","Image","className","src","text","innerText","parent","appendChild","getElementCurrentPos","element","Array","prototype","indexOf","call","buildOfferItem","offer","offerEl","offerBodyEl","bannerUrl","tagsListEl","content_parameters","title","tags","forEach","tag","creditsEl","credits","hint","incrementCounters","campaign","checkClickCounter","counter","getTagScore","getOfferScoreByTags","reduce","prev","next","bindOfferItem","addEventListener","removeChild","position","childNodes","then","console","log","window","location","clickUrl","addOfferToList","body","trackerPromise","map","sort","a","b","isIncentive","isFallback","error"],"mappings":"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","file":"script.min.js","sourcesContent":["/*\n  Vanilla JS implementation: way faster than React.js\n*/\n\n(function () {\n  'use strict';\n  \n  var offersURL    = 'http://www.360dialog.com/fe-challenge/offers.json';\n  var trackingURL  = 'http://rt.360dialog.io/test/track';\n  var offersListEl = document.querySelector('.offers');\n  var statusEl    = document.querySelector('.status');\n  \n  var loadFromStorage = function (store) {\n    return JSON.parse(localStorage.getItem(store) || '{}');\n  };\n  \n  var saveIntoStorage = function (store, val) {\n    localStorage.setItem(store, JSON.stringify(val));\n  };\n  \n  var fetchOffers = function () {\n    return new Promise(function (resolve, reject) {\n      var request = new XMLHttpRequest();\n      request.open('GET', offersURL, true);\n\n      request.onload = function() {\n        if (this.status >= 200 && this.status < 300) {\n          var offers = JSON.parse(this.response).offers;\n          resolve(offers);\n        } else {\n          reject('There is an error from server! %s', this.status);\n        }\n      };\n\n      request.send();  \n    })\n  };\n  \n  var sendToTracker = function (data) {\n    return new Promise(function (resolve, reject) {\n      resolve(data);\n    })\n  };\n  \n  var createElement = function (opts) {\n    var el = opts.name === 'img' ?\n             new Image() :\n             document.createElement(opts.name);\n\n    if (opts.className) el.className = opts.className;\n    if (opts.src) el.src = opts.src;\n    if (opts.text) el.innerText = opts.text;\n    if (opts.parent) opts.parent.appendChild(el);  \n    \n    return el;\n  };\n  \n  var getElementCurrentPos = function (parent, element) {\n    return Array.prototype.indexOf.call(parent, element);\n  };\n  \n  // builds the offer's DOM, faster than using innerHTML\n  var buildOfferItem = function (offer) {\n    var offerEl = createElement({\n      name: 'li',\n      className: 'offers__item'\n    });\n    \n    // banner\n    var bannerEl = createElement({\n      name: 'img',\n      className: 'offers__banner',\n      src: offer.bannerUrl,\n      parent: offerEl\n    });\n    \n    // offer item body\n    var offerBodyEl = createElement({\n      name: 'div',\n      className: 'offers__body',\n      parent: offerEl\n    });\n    \n    // title\n    var titleEl = createElement({\n      name: 'span',\n      className: 'offers__title',\n      text: offer.content_parameters.title,\n      parent: offerBodyEl\n    });\n    \n    // tags\n    var tagsListEl = createElement({\n      name: 'ul',\n      className: 'offers__taglist',\n      parent: offerBodyEl\n    });\n    \n    offer.content_parameters.tags.forEach(function (tag) {\n      createElement({\n        name: 'li',\n        className: 'offers__tag',\n        text: tag,\n        parent: tagsListEl\n      });\n    });\n    \n    // credits\n    var creditsEl = createElement({\n      name: 'div',\n      className: 'offers__credits-container',\n      parent: offerEl\n    });\n    \n    var creditsCounterEl = createElement({\n      name: 'span',\n      className: 'offers__credits-counter',\n      text: offer.credits,\n      parent: creditsEl\n    });\n    \n    // hint\n    var hintEl = createElement({\n      name: 'span',\n      className: 'offers__hint',\n      text: offer.content_parameters.hint,\n      parent: creditsEl\n    });\n    \n    return offerEl;\n  };\n  \n  // increments the tag and click counters, saved on localStorage\n  var incrementCounters = function (offer) {\n    // increments offer counter and save it\n    var offers = loadFromStorage('offers');\n    offers[offer.campaign] = offers[offer.campaign] ?\n                             +offers[offer.campaign] + 1 : 1;\n    saveIntoStorage('offers', offers);\n    \n    // increment tag counter and save it\n    var tags = loadFromStorage('tags');\n    offer.content_parameters.tags.forEach(function (tag) {\n      tags[tag] = tags[tag] ? +tags[tag] + 1 : 1;\n    });\n    saveIntoStorage('tags', tags);\n  };\n  \n  // returns true if the offer has been clicked 3 times\n  var checkClickCounter = function (offer) {\n    var offers = loadFromStorage('offers');\n    var counter = offers[offer.campaign] ? offers[offer.campaign] : 0;\n    return counter >= 3;\n  };\n  \n  // retrives the single tag score from localStorage\n  var getTagScore = function (tag) {\n    var tags = loadFromStorage('tags');\n    return +tags[tag] || 0;\n  };\n  \n  var getOfferScoreByTags = function (offer) {\n    return offer.content_parameters.tags.reduce(function (prev, next) {\n      return getTagScore(prev) + getTagScore(next);\n    }, 0);\n  };\n  \n  var bindOfferItem = function (offer, offerEl) {\n    // redirect the user to the app location, but send the tracking data first\n    offerEl.addEventListener('click', function () {\n      incrementCounters(offer);\n\n      if (checkClickCounter(offer)) {\n        offersListEl.removeChild(offerEl);\n      }\n      \n      sendToTracker({\n        'offer': {\n          'campaign': offer.campaign,\n          'position': getElementCurrentPos(offersListEl.childNodes, offerEl)\n        }\n      }).then(function (data) {\n        console.log(data);\n        window.location = offer.clickUrl;\n      });\n\n    }, false);\n  };\n  \n  var addOfferToList = function (offerEl) {    \n    offersListEl.appendChild(offerEl);\n  };\n  \n  // starting point, we collect the offers and send the campaign ids to analytics\n  fetchOffers()\n    .then(function (offers) {\n      document.body.removeChild(statusEl);\n      \n      // send the offers to the tracker using the original order\n      var trackerPromise = sendToTracker({\n        'offers': offers.map(function (offer) {\n          return offer.campaign;\n        })\n      });\n      \n      // sort them by tags' score\n      offers.sort(function (a, b) {\n        // console.log(getOfferScoreByTags(a), getOfferScoreByTags(b));\n        if (getOfferScoreByTags(a) > getOfferScoreByTags(b)) {\n          return -1;\n        }\n        \n        if (getOfferScoreByTags(a) < getOfferScoreByTags(b)) {\n          return 1;\n        }\n        \n        return 0;\n      });\n    \n      \n      // add the offers to the view\n      offers.forEach(function (offer) {\n        // if the offer is ok add it to the list  \n        if (offer.isIncentive && !offer.isFallback && !checkClickCounter(offer)) {\n          var offerEl = buildOfferItem(offer);\n          bindOfferItem(offer, offerEl);\n          addOfferToList(offerEl);  \n        }\n      });\n      \n      return trackerPromise;\n    })\n    .then(function (data) {\n      console.log(data);\n    })\n    .catch(function (error) {\n      // report any errors\n      statusEl.innerText = error;\n    });\n})();"]}